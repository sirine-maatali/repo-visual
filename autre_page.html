<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autre Page</title>
    <link rel="stylesheet" href="./styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
    <div class="navbar">
        <h1>Autre Page - Filtrage des Données</h1>
        <button class="retourButton" onclick="window.location.href='report.html'">Retour au rapport</button>
    </div>
    <div class="content">
        <h2>Filtrer les données</h2>
        <p>Entrez un pourcentage minimum de tests réussis (PASS) pour filtrer les features :</p>
        <input type="number" id="filterInput" placeholder="Exemple : 50" min="0" max="100">
        <button onclick="filterData()">Filtrer</button>

        <!-- Graphiques filtrés -->
        <div class="chart-container">
            <div class="chart-wrapper bar">
                <h3>Répartition des statuts par feature (filtré)</h3>
                <canvas id="filteredBarChart"></canvas>
            </div>
            <div class="chart-wrapper pie">
                <h3>Répartition globale des statuts (filtré)</h3>
                <canvas id="filteredPieChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Récupérer les données partagées depuis report.html
        const sharedData = window.sharedData;

        // Fonction pour filtrer les données
        function filterData() {
            const filterValue = parseFloat(document.getElementById('filterInput').value);
            if (isNaN(filterValue)) {
                alert("Veuillez entrer un pourcentage valide.");
                return;
            }

            // Filtrer les features avec un pourcentage de PASS >= filterValue
            const filteredData = sharedData.filter(entry => {
                const totalTests = entry.PASS + entry.NOTEXECUTED + entry.NOKMINOR + entry.NOKMAJOR;
                const passPercentage = (entry.PASS / totalTests) * 100;
                return passPercentage >= filterValue;
            });

            // Mettre à jour les graphiques avec les données filtrées
            updateCharts(filteredData);
        }

        // Fonction pour mettre à jour les graphiques
        function updateCharts(data) {
            const featureLabels = data.map(entry => entry.feature);
            const passData = data.map(entry => entry.PASS);
            const notExecutedData = data.map(entry => entry.NOTEXECUTED);
            const nokMinorData = data.map(entry => entry.NOKMINOR);
            const nokMajorData = data.map(entry => entry.NOKMAJOR);

            // Mettre à jour le graphique à barres
            const barChart = new Chart(document.getElementById('filteredBarChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: featureLabels,
                    datasets: [
                        {
                            label: 'PASS',
                            backgroundColor: '#81C784',
                            data: passData
                        },
                        {
                            label: 'NOT EXECUTED',
                            backgroundColor: '#A5D6A7',
                            data: notExecutedData
                        },
                        {
                            label: 'NOK MINOR',
                            backgroundColor: '#FF9800',
                            data: nokMinorData
                        },
                        {
                            label: 'NOK MAJOR',
                            backgroundColor: '#F44336',
                            data: nokMajorData
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            });

            // Mettre à jour le graphique en camembert
            const pieChart = new Chart(document.getElementById('filteredPieChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['PASS', 'NOT EXECUTED', 'NOK MINOR', 'NOK MAJOR'],
                    datasets: [{
                        data: [
                            passData.reduce((a, b) => a + b, 0),
                            notExecutedData.reduce((a, b) => a + b, 0),
                            nokMinorData.reduce((a, b) => a + b, 0),
                            nokMajorData.reduce((a, b) => a + b, 0)
                        ],
                        backgroundColor: ['#81C784', '#A5D6A7', '#FF9800', '#F44336']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        datalabels: {
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum).toFixed(2) + "%";
                                return percentage;
                            },
                            color: '#000',
                            font: { weight: 'bold', size: 10 }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
    </script>
</body>
</html>